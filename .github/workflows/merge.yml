name: auto merge

on:
  schedule:
    - cron: '0 22 * * 6' # 每周六 22:00 UTC 运行
  workflow_dispatch: # 允许手动触发

jobs:
  sync_and_publish:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout 本地仓库
    # 使用 PERSONAL_TOKEN 来 checkout，这样后续才有权限 push 回仓库
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PERSONAL_TOKEN }}
        fetch-depth: 0 # 获取所有历史记录，以便正确合并

    # 2. 设置 Git 环境并同步 upstream
    - name: Sync and merge upstream
      run: |
        # 配置 git 用户信息，否则无法提交
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # 添加上游仓库地址
        git remote add upstream https://github.com/metowolf/vCards.git
        
        # 从上游仓库拉取最新改动
        git fetch upstream
        
        # 切换到你的主分支（假设是 master）
        git checkout master
        
        # 合并上游仓库的 master 分支到你的当前分支
        # 如果你希望在没有冲突时自动创建一个合并提交，请使用下面的命令
        git merge upstream/master
        
        # 如果你只希望在可以“快进式合并”时才合并，防止产生合并提交，可以使用 --ff-only
        # git merge --ff-only upstream/master
        
        # 将合并后的代码推送到你自己的仓库
        git push origin master
        
    # 3. 安装依赖
    - name: Install dependencies
      run: yarn
    
    # 4. 运行 npm 脚本生成 radicale 数据
    - name: Generate Radicale data
      run: yarn radicale

    - name: Check gh auth status
      env:
        GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
      run: gh auth status

    # 5. 打包并创建 Release
    # 注意：你的 gh release create 命令有一个小语法错误（逗号是中文的），已修正
    - name: Archive and Create Release
      env:
        GH_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
      run: |
        zip -r radicale-data.zip radicale/
        gh release create $(date +'%Y%m%d%H%M%S')-$(git log --format=%h -1) radicale-data.zip --notes "Automated release of Radicale data"
